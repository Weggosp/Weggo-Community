{% extends 'bases/weggo_v1_base.html' %}


{% block metadatos %}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Weggo App utiliza tecnología avanzada para ofrecer información actualizada y contrastada. ★ Compara cientos de ofertas ✓ Bajos precios ✓ Rápido y fácil ✓ Pagos seguros.">
<meta name="keywords" content="Camper, viajes, campings, autocaravanas, caravanas, camperizado, tutoriales, informacion, alquiler, furgoneta, vacaciones, España">
<meta name="author" content="Ruben Ayuso">
<meta name="generator" content="Weggo Application 1.0.21">
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
{% endblock %}

{% block css %}
<link href="{{ url_for('static', filename='vendor/select2/dist/css/select2.min.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container pb-4">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        var currentPage = 1;
        var newsPerPage = 5;
        var newsData = [];
        var filteredData = [];

        $.ajax({
            url: '/api/v1/news',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                newsData = data;
                filteredData = data;
                displayNews();
            },
            error: function(xhr, status, error) {
                console.log('No se ha podido obtener las noticias. Vuelve a intentarlo');
            }
        });

        function displayNews() {
            var startIndex = (currentPage - 1) * newsPerPage;
            var endIndex = startIndex + newsPerPage;
            var newsHtml = '';
            
            for (var i = startIndex; i < endIndex && i < filteredData.length; i++) {
                newsHtml += '<article class="col pb-2 pb-md-1">';
                newsHtml += '<a class="d-block position-relative mb-3" href="/news/' + filteredData[i].titleUrl + '">';
                if (filteredData[i].badge && filteredData[i].badge !== 'none' && filteredData[i].badge !== 'false') {
                newsHtml += '<span class="badge bg-info position-absolute top-0 end-0 m-3 fs-sm">' + filteredData[i].badge + '</span>';
                }
                newsHtml += '<img class="d-block rounded-3" src="https://europe-weggo-bucket.s3.eu-west-3.amazonaws.com/weggo.es/images/news/' + filteredData[i].image + '" alt="' + filteredData[i].alt + '" style="max-height:17.5rem">';
                newsHtml += '</a>';
                newsHtml += '<a class="fs-sm text-uppercase text-decoration-none" href="' + filteredData[i].categoryUrl + '">' + filteredData[i].category + '</a>';
                newsHtml += '<h3 class="h5 mb-2 pt-1"><a class="nav-link" href="/news/' + filteredData[i].titleUrl + '">' + filteredData[i].title + '</a></h3>';
                newsHtml += '<p class="mb-1">' + filteredData[i].shortDescription + '</p>';
                newsHtml += '<div class="d-flex align-items-center text-muted"';
                newsHtml += '<p class="fs-sm border-end pt-0 pe-3 me-3"></p>';

                newsHtml += '<div class="fs-sm border-end pe-3 me-3">'+ filteredData[i].created +'</div><div class="d-flex align-items-center me-3"><i class="bx bx-like fs-lg me-1"></i><span class="fs-sm">'+ filteredData[i].likesCount +'</span></div><div class="d-flex align-items-center me-3"><i class="bx bx-comment fs-lg me-1"></i><span class="fs-sm">'+ filteredData[i].commentsCount +'</span></div>';

                newsHtml += '</div></div></a></article>';
            }
            
            $('#news-container').html(newsHtml);
            $('#pagination').html(generatePagination());
            }

        function generatePagination() {
            var totalPages = Math.ceil(filteredData.length / newsPerPage);
            var paginationHtml = '';

            for (var i = 1; i <= totalPages; i++) {
                paginationHtml += '<li class="page-item' + (i === currentPage ? ' active' : '') + '"><a class="page-link" href="#">' + i + '</a></li>';
            }

            return paginationHtml;
        }

        $('#search-form').submit(function(event) {
            event.preventDefault();

            var searchText = $('#search-text').val().toLowerCase();
            var categoryFilter = $('#category-filter').val();
            var dateFilter = $('#date-filter').val();   

            filteredData = newsData.filter(function(newsItem) {
                return (
                    (newsItem.title.toLowerCase().indexOf(searchText) !== -1 || newsItem.shortDescription.toLowerCase().indexOf(searchText) !== -1) &&
                    (categoryFilter === '' || newsItem.category === categoryFilter) &&
                    (dateFilter === '' || newsItem.newDate === dateFilter)
                );
            });

            currentPage = 1;
            displayNews();
        });

        $('#pagination').on('click', '.page-link', function(event) {
            event.preventDefault();

            currentPage = parseInt($(this).text());
            displayNews();
        });
    });
</script>
<style>
    .news-item {
        margin-bottom: 20px;
    }
</style>

    <form id="search-form" class="py-2">
        <div class="row gy-3 mb-4 pb-2">
            <div class="col-md-3 order-md-1 order-2">
                <div class="position-relative">
                <input id="search-text" class="form-control pe-5" type="text" placeholder="Buscar.."><i class="fi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
                <i class="bx bx-search position-absolute top-50 end-0 translate-middle-y me-3 zindex-5 fs-lg"></i>
                </div>
            </div>
            <div class="col-md-6 order-md-2 order-1">
                <div class="row gy-3">
                <div class="col-6 d-flex flex-sm-row flex-column align-items-sm-center">
                    <label class="d-inline-block me-sm-2 mb-sm-0 mb-2 text-nowrap" for="categories-filter"><i class="fi-align-left mt-n1 me-2 align-middle opacity-70"></i>Category:</label>
                    <select id="category-filter" class="form-select">
                        <option value="">Todas las categorías</option>
                        {% for i in categories %}
                        <option value="{{i}}">{{i}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6 d-flex flex-sm-row flex-column align-items-sm-center">
                    <label class="d-inline-block me-sm-2 mb-sm-0 mb-2 text-nowrap" for="sortby"><i class="fi-arrows-sort mt-n1 me-2 align-middle opacity-70"></i>Sort by:</label>
                    <select class="form-select" id="sortby">
                    <option>Newest</option>
                    <option>Oldest</option>
                    <option>Popular</option>
                    <option>Sponsored</option>
                    </select>
                </div>
                </div>
            </div>
            <div class="col order-md-2 order-1">
                <input type="date" class="form-control" id="date-filter">
            </div>

            <div class="col order-md-3">
                <button type="submit" class="btn btn-primary bg-gradient-primary fs-xl p-2 border-0"><i class="bx bx-search"></i></button>
            </div>
        </div>
    </form>

    <div id="news-container" class="row row-cols-md-2 row-cols-1 gy-md-5 gy-4 mb-lg-5 mb-4">
        <div class="m-3 mt-4">
            <div id="loading" class="page-loading bg-white">
                <div class="page-loading-inner">
                  <div class="page-spinner"></div><span>Cargando...</span>
                </div>
              </div>
        </div>
    </div>

    <ul id="pagination" class="pagination"></ul>
</div>
</body>
{% endblock %}
